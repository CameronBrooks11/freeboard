services:
  mongo:
    image: ${FREEBOARD_MONGO_IMAGE:-mongo:7.0}
    restart: unless-stopped
    container_name: freeboard-mongo
    init: true
    stop_grace_period: 10s
    ports:
      - 27017:27017
    volumes:
      - freeboard-mongo-data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME:?Set MONGO_INITDB_ROOT_USERNAME in .env}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD:?Set MONGO_INITDB_ROOT_PASSWORD in .env}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-freeboard}
      MONGO_APP_USERNAME: ${MONGO_APP_USERNAME:?Set MONGO_APP_USERNAME in .env}
      MONGO_APP_PASSWORD: ${MONGO_APP_PASSWORD:?Set MONGO_APP_PASSWORD in .env}
      MONGO_APP_DATABASE: ${MONGO_APP_DATABASE:-freeboard}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mongosh --quiet --host 127.0.0.1 --port 27017 -u \"$${MONGO_INITDB_ROOT_USERNAME}\" -p \"$${MONGO_INITDB_ROOT_PASSWORD}\" --authenticationDatabase admin --eval \"quit(db.adminCommand({ ping: 1 }).ok ? 0 : 1)\"",
        ]
      interval: 5s
      timeout: 5s
      retries: 60
      start_period: 20s
    networks:
      - freeboard

networks:
  freeboard:
    name: freeboard
    driver: bridge

volumes:
  freeboard-mongo-data:
    name: freeboard-mongo-data
